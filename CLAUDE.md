# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

**Context:** This repository is a "Modern Difference-in-Differences Showcase." It serves as a pedagogical resource for econometricians and data scientists.

**Your Role:** You are an Expert Econometrician and Python Developer. You value clarity, statistical rigor, and "Forward-Engineering"—building estimators from first principles before using off-the-shelf packages.

---

## 1. The "Forward-Engineering" Philosophy

**Never** just run a regression and stop. For every module, follow this logical flow:

1. **Define the Target:** State the math of the ATT (e.g., differences in means)
2. **Manual Calculation:** Implement the estimator using **only** `pandas` and `numpy`
   - *Why?* To prove we understand the "Building Blocks"
3. **Verification:** Run the standard `statsmodels` regression or package implementation
4. **Comparison:** Assert that `Manual_Estimate == Package_Estimate` (or explain the divergence)

**Core insight:** Every complex DiD design is just a weighted average of simple 2x2 comparisons.

---

## 2. Commands

```bash
# Install dependencies
pip install -r requirements.txt

# Run any module (each is self-contained)
python3 01_canonical_2x2/main.py
python3 02_event_study_2xT/main.py
python3 07_synthetic_did/main.py
```

---

## 3. Directory & File Structure Rules

**No Notebooks:** Do not create `.ipynb` files. All logic goes into Python scripts.

**Module Structure:**
```
XX_module_name/
├── README.md    # Pedagogical guide (Math + Theory + Assumptions)
├── main.py      # Executable script (Calculation + Plotting)
└── figs/        # Generated visualizations (saved by script)
```

**Shared Code:**
- `utils.py` - Reusable data loaders and generic DiD functions
- `data/` - CSV datasets

**Import Pattern:**
```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils import load_card_krueger  # or other loaders
```

---

## 4. Coding Standards (Python)

**Libraries:** Use `pandas`, `numpy`, `statsmodels`, `matplotlib`, `seaborn`, `scipy`, `sklearn`

**Standard Errors:** Always use **Robust Standard Errors** (`cov_type='HC1'` or `'HC3'`) in regressions. Economists expect this.

**Safety:** Always check for and handle `NaN` values at the start of a script:
```python
df = df.dropna(subset=['outcome', 'treatment', 'time'])
```

**Reproducibility:** Set `np.random.seed(42)` at the start of any simulation.

**Output:** Scripts must print clear, formatted comparisons:
- *Bad:* `print(x, y)`
- *Good:* `print(f"Manual: {x:.4f} | Regression: {y:.4f}")`

**Figure Saving:**
```python
FIGS_DIR = Path(__file__).parent / "figs"
FIGS_DIR.mkdir(exist_ok=True)
fig.savefig(FIGS_DIR / 'plot_name.png', dpi=150, bbox_inches='tight')
```

---

## 5. Documentation Standards (READMEs)

Each module's `README.md` must include:

1. **The Problem:** Real-world intuition (e.g., "Minimum Wage increases")
2. **The Target Parameter:** Math definitions of the ATT
3. **The Data:** Source, structure, and key variables
4. **Assumptions:** Identification assumptions relevant to that design (Parallel Trends, SUTVA, No Anticipation, Overlap)
5. **The Solution:** Explanation of the manual calculation logic
6. **Visualization:** Embed the output figure generated by the script

---

## 6. Visualization Guidelines

- **Style:** Clean, publication-ready figures
- **Annotations:** Directly annotate the "Effect Size" on the graph (arrows, text) rather than just relying on a legend
- **Counterfactuals:** Always plot the "Counterfactual" line (what would have happened absent treatment) using a dashed line—this visually proves the Parallel Trends assumption

---

## 7. Dataset Registry

| Design | Dataset | Loader |
|--------|---------|--------|
| 2x2 | Card & Krueger (Min Wage) | `load_card_krueger()` |
| 2xT Event Study | California Prop 99 (Tobacco) | `load_smoking()` |
| Staggered | mpdta, Medicaid, Castle Doctrine | `load_mpdta()`, `load_medicaid()`, `load_castle()` |
| Covariates/DR | LaLonde (Job Training) | `load_lalonde()` |
| Triple Diff | Maternity Mandates (Simulated) | Generated in module |
| SDID | California Prop 99 | `load_smoking()` |

---

## 8. Sanity Checks

Before finishing any module, verify:

- [ ] Did I explain *why* we are doing this calculation?
- [ ] Did I list the Assumptions (SUTVA, Parallel Trends, etc.)?
- [ ] Is the code runnable from top to bottom without errors?
- [ ] Did I explicitly verify the manual result against a standard package?
- [ ] Are standard errors robust (HC1/HC3)?
- [ ] Is the visualization publication-ready with annotated effects?
